<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>æ–°å¢å°ˆæ¡ˆ - ip camera</title>
    
	<link rel="stylesheet" href="static/css/createProject.css">
</head>
<body>

    <div id="header-container"></div>

    <div class="main-content">
        <div class="container">
            <div class="step-header">
                <h1>æ–°å¢ç›£æ§å°ˆæ¡ˆ</h1>
                <p>è«‹ä¾ç…§æ­¥é©Ÿå®Œæˆå°ˆæ¡ˆè¨­å®š</p>
            </div>

            <form id="multiStepForm">
                <!-- æ­¥é©Ÿ 1: å°ˆæ¡ˆåŸºæœ¬è³‡è¨Š -->
                <div class="step active" id="step1">
                    <h2>æ­¥é©Ÿ 1ï¼šå°ˆæ¡ˆåŸºæœ¬è³‡è¨Š</h2>
                    
                    <div class="form-group">
                        <label for="projectName">å°ˆæ¡ˆåç¨± *</label>
                        <input type="text" id="projectName" name="project_name" placeholder="è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±" required>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• - ç¬¬ä¸€é åªé¡¯ç¤ºå³é‚Š -->
                    <div class="navigation-buttons">
                        <div></div> <!-- ç©ºçš„å·¦å´ -->
                        <button type="button" class="nav-button" onclick="nextStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 2: é¸æ“‡æ”å½±æ©Ÿ -->
                <div class="step" id="step2">
                    <h2>æ­¥é©Ÿ 2ï¼šé¸æ“‡æ”å½±æ©Ÿ</h2>
                    
                    <div class="form-group">
                        <label for="cameraSelect">æ”å½±æ©Ÿ *</label>
                        <select id="cameraSelect" name="camera_id" >
					<!--	<select id="cameraSelect" name="camera_id" required>	-->
                            <option value="">-- è«‹é¸æ“‡æ”å½±æ©Ÿ --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>æ”å½±æ©Ÿè³‡è¨Š</label>
                        <div id="cameraInfo" style="padding: 16px; background: #ffffff; border-radius: 8px; color: #666; border: 2px solid #e6d7ff;">
                            è«‹å…ˆé¸æ“‡æ”å½±æ©Ÿä»¥æŸ¥çœ‹è©³ç´°è³‡è¨Š
                        </div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• - å…©é‚Šéƒ½é¡¯ç¤º -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-button" onclick="prevStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <button type="button" class="nav-button" onclick="nextStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>

				<!--æ–°å¢æ­¥é©Ÿ 3: è¼¸å…¥è£ç½®ID -->
				<div class="step" id="step3">
					<h2>æ­¥é©Ÿ 3ï¼šè¼¸å…¥è£ç½® ID</h2>
					
                    <div class="form-group">
                        <label for="deviceID">è£ç½® ID *</label>
                        <input type="text" id="deviceID" name="device_id" placeholder="è«‹è¼¸å…¥è£ç½® ID" required>
                    </div>
                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-button" onclick="prevStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <button type="button" class="nav-button" onclick="nextStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>					
					
				
				</div>
				
                <!-- æ­¥é©Ÿ 4: é¸æ“‡ AI æ¨¡å‹ -->
                <div class="step" id="step4">
                    <h2>æ­¥é©Ÿ 4ï¼šé¸æ“‡ AI ç›£æ§æ¨¡å‹</h2>
                    
                    <div class="form-group">
                        <label>è«‹é¸æ“‡è¦ä½¿ç”¨çš„ AI æ¨¡å‹ï¼š</label>
                        <div class="checkbox-group" id="modelsContainer"></div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-button" onclick="prevStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <button type="button" class="nav-button" onclick="nextStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>



                <!-- æ­¥é©Ÿ 5: é¸æ“‡è¯çµ¡äºº -->
                <div class="step" id="step5">
                    <h2>æ­¥é©Ÿ 5ï¼šé¸æ“‡é€šçŸ¥è¯çµ¡äºº</h2>
                    
                    <div class="form-group">
                        <label>è«‹é¸æ“‡æ¥æ”¶è­¦å ±é€šçŸ¥çš„è¯çµ¡äººï¼š</label>
                        <div class="checkbox-group" id="contactsContainer">
                            <!-- è¯çµ¡äººé¸é …å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-button" onclick="prevStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <button type="button" class="nav-button" onclick="nextStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 6: é‹ä½œæ™‚é–“è¨­å®š -->
                <div class="step" id="step6">
                    <h2>æ­¥é©Ÿ 6ï¼šé‹ä½œæ™‚é–“è¨­å®š</h2>

                    <div class="form-group">
                        <label>æ¯æ—¥é‹ä½œæ™‚é–“</label>
                        <div class="time-grid">
                            <div>
                                <label for="dailyStartTime">é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="dailyStartTime" name="daily_start_time" value="00:00">
                            </div>
                            <div>
                                <label for="dailyEndTime">çµæŸæ™‚é–“</label>
                                <input type="time" id="dailyEndTime" name="daily_end_time" value="23:59">
                            </div>
                        </div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-button" onclick="prevStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <button type="button" class="nav-button" onclick="nextStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 7: ç¢ºèªèˆ‡æäº¤ -->
                <div class="step" id="step7">
                    <h2>æ­¥é©Ÿ 7ï¼šç¢ºèªå°ˆæ¡ˆè³‡è¨Š</h2>
                    
                    <div class="preview-section" id="previewSection">
                        <!-- é è¦½å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <div class="submit-section">
                        <button type="submit" class="submit-button">
                            ğŸš€ å»ºç«‹å°ˆæ¡ˆ
                        </button>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• - æœ€å¾Œä¸€é åªé¡¯ç¤ºå·¦é‚Š -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-button" onclick="prevStep()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                            </svg>
                        </button>
                        <div></div> <!-- ç©ºçš„å³å´ -->
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ç«ç®­å‹•ç•«å…ƒç´  
    <div class="rocket-animation" id="rocketAnimation">ğŸš€</div>-->

    <!-- ç›£è¦–å™¨çˆ†ç‚¸å‹•ç•«å®¹å™¨ 
    <div class="camera-explosion" id="cameraExplosion"></div>-->

    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
            <div class="progress-text" id="progressText">1 / 7</div>
        </div>
    </div>

    <script>
	
const API_BASE = 'http://210.240.202.108:5000';
let mockCameras = [];
let mockModels = [];
let mockContacts = [];

/****************************************** æ­¥é©ŸåŠå‹•ç•«å€ ****************************************/
// å…¨åŸŸè®Šæ•¸
const steps = document.querySelectorAll(".step");
const progressBarFill = document.getElementById("progressBarFill");
const progressText = document.getElementById("progressText");

let currentStep = 0;

// æ›´æ–°é€²åº¦æ¢
function updateProgress() {
    const percentage = ((currentStep + 1) / steps.length) * 100;
    progressBarFill.style.width = percentage + "%";
    progressText.textContent = `${currentStep + 1} / ${steps.length}`;
}

// é¡¯ç¤ºæŒ‡å®šæ­¥é©Ÿ
function showStep(index) {
    steps.forEach((step, i) => {
        step.classList.toggle("active", i === index);
    });
    updateProgress();
}

// ä¸‹ä¸€æ­¥
function nextStep() {
    if (validateCurrentStep() && currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
        // å¦‚æœæ˜¯æœ€å¾Œä¸€æ­¥ï¼Œæ›´æ–°é è¦½
        if (currentStep === steps.length - 1) {
            updatePreview();
        }
    }
}

// ä¸Šä¸€æ­¥
function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
    }
}

/*
// ç«ç®­çˆ†ç‚¸å‹•ç•«
        function playRocketExplosion() {
            const rocket = document.getElementById('rocketAnimation');
            const explosion = document.getElementById('cameraExplosion');

            // é¡¯ç¤ºç«ç®­ä¸¦é–‹å§‹ä¸Šå‡å‹•ç•«
            rocket.style.opacity = '1';
            rocket.classList.add('rocket-launch');

            // 2ç§’å¾Œé–‹å§‹ç›£è¦–å™¨çˆ†ç‚¸æ•ˆæœ
            setTimeout(() => {
                // å‰µå»ºå¤šå€‹ç›£è¦–å™¨åœ–æ¨™
                for (let i = 0; i < 12; i++) {
                    const camera = document.createElement('div');
                    camera.className = 'camera-icon camera-explode';
                    camera.innerHTML = 'ğŸ“¹';

                    // éš¨æ©Ÿæ–¹å‘å’Œè·é›¢
                    const angle = (i * 30) * Math.PI / 180; // æ¯30åº¦ä¸€å€‹
                    const distance = 100 + Math.random() * 100; // 100-200pxè·é›¢
                    const x = Math.cos(angle) * distance;
                    const y = Math.sin(angle) * distance;

                    camera.style.setProperty('--x', x + 'px');
                    camera.style.setProperty('--y', y + 'px');

                    explosion.appendChild(camera);
                }

                // 3ç§’å¾Œæ¸…ç†å‹•ç•«å…ƒç´ 
                setTimeout(() => {
                    rocket.classList.remove('rocket-launch');
                    rocket.style.opacity = '0';
                    explosion.innerHTML = '';
                }, 3000);
            }, 2000);
        }
*/


// é©—è­‰ç•¶å‰æ­¥é©Ÿ
function validateCurrentStep() {
    const currentStepElement = steps[currentStep];
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
            field.focus();
            return false;
        }
    }
    // ç‰¹æ®Šé©—è­‰
    if (steps[currentStep].id === "step4") { 	// AI æ¨¡å‹æ­¥é©Ÿ
        const checkedModels = currentStepElement.querySelectorAll('input[name="model_id"]:checked');
        if (checkedModels.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ AI æ¨¡å‹');
            //return false;
			return true;
        }
    }
    if (steps[currentStep].id === "step5") { 	// è¯çµ¡äººæ­¥é©Ÿ
        const checkedContacts = currentStepElement.querySelectorAll('input[name="contact_id"]:checked');
        if (checkedContacts.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¯çµ¡äºº');
            //return false;
			return true;
        }
    }
    if (steps[currentStep].id === "step6") {	//æ™‚é–“æ­¥é©Ÿ
        const startInput = document.querySelector('input[name="daily_start_time"]');
        const endInput = document.querySelector('input[name="daily_end_time"]');
        const start = startInput.value;
        const end = endInput.value;
        if (!start || !end) {
            alert('è«‹è¨­å®šæ¯æ—¥é‹ä½œæ™‚é–“');
            //return false;
			return true;
        }
        if (start >= end) {
            alert('é–‹å§‹æ™‚é–“éœ€æ—©æ–¼çµæŸæ™‚é–“');
            //return false;
			return true;
        }
    }
    return true;
}

/*******************************æ”å½±æ©Ÿè³‡è¨Š************************************/
async function loadCameras() {
  const token = localStorage.getItem("jwt");
  const cameraSelect = document.getElementById('cameraSelect');
  const infoBox = document.getElementById('cameraInfo');

  // æ¸…ç©ºèˆŠè³‡æ–™
  cameraSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡æ”å½±æ©Ÿ --</option>';
  infoBox.textContent = 'è«‹å…ˆé¸æ“‡æ”å½±æ©Ÿä»¥æŸ¥çœ‹è©³ç´°è³‡è¨Š';

  fetch(`${API_BASE}/camera`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ token })
  })
  .then(res => {
    if (res.status === 200) {
      return res.json();
    } else {
      return res.json().then(err => {
        throw new Error(err.error || `ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`);
      });
    }
  })
  .then(data => {
    if (!Array.isArray(data.cameras)) {
      alert("âš ï¸ å¾Œç«¯å›å‚³æ ¼å¼éŒ¯èª¤");
      return;
    }

    if (data.cameras.length === 0) {
      cameraSelect.innerHTML = '<option value="">ğŸš« ç„¡å¯ç”¨æ”å½±æ©Ÿ</option>';
      return;
    }

    // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
    mockCameras.length = 0;
    mockCameras.push(...data.cameras);

    // æ¸²æŸ“ä¸‹æ‹‰é¸å–®
    data.cameras.forEach(camera => {
      const option = document.createElement('option');
      option.value = camera.camera_id;
      option.textContent = `${camera.camera_name} (${camera.ip_address})`;
      option.dataset.camera = JSON.stringify(camera);
      cameraSelect.appendChild(option);
    });

    // ç¶å®š onchange æ›´æ–°æ”å½±æ©Ÿè³‡è¨Š
    cameraSelect.onchange = function () {
      const selectedOption = this.selectedOptions[0];
      if (!selectedOption || !selectedOption.dataset.camera) {
        infoBox.textContent = 'è«‹å…ˆé¸æ“‡æ”å½±æ©Ÿä»¥æŸ¥çœ‹è©³ç´°è³‡è¨Š';
        return;
      }

      const cam = JSON.parse(selectedOption.dataset.camera);
      infoBox.innerHTML = `
        <strong>${cam.camera_name}</strong><br>
        ğŸ“ IP ä½å€ï¼š${cam.ip_address}<br>
        ğŸ·ï¸ å“ç‰Œï¼š${cam.device_brand || 'ç„¡'}<br>
        ğŸ”¢ å‹è™Ÿï¼š${cam.device_model || 'ç„¡'}<br>
        ğŸ‘¤ å¸³è™Ÿï¼š${cam.camera_username || 'ç„¡'}<br>
        ğŸ”— RTSPï¼š${cam.rtsp_url || 'ç„¡'}<br>
        ğŸ•’ å»ºç«‹æ™‚é–“ï¼š${cam.created_at || 'æœªçŸ¥'}
      `;
    };
  })
  .catch(err => {
    console.error("âŒ fetch å¤±æ•—ï¼š", err);
    alert("âŒ ç„¡æ³•èˆ‡ä¼ºæœå™¨é€£ç·šï¼š" + err.message);
  });
}




/*******************************AI æ¨¡å‹è³‡è¨Š************************************/
async function loadModels() {
  const token = localStorage.getItem("jwt");
  const modelsContainer = document.getElementById('modelsContainer');

  modelsContainer.innerHTML = '<p style="color: gray;">ğŸ”„ è¼‰å…¥æ¨¡å‹ä¸­...</p>';

  fetch(`${API_BASE}/model`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ token })
  })
  .then(res => {
    if (res.status === 200) {
      return res.json();
    } else {
      return res.json().then(err => {
        throw new Error(err.error || `ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`);
      });
    }
  })
  .then(data => {
    modelsContainer.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥ä¸­æç¤º

    if (!Array.isArray(data.models)) {
      modelsContainer.innerHTML = '<p style="color: red;">âš ï¸ æ¨¡å‹è³‡æ–™æ ¼å¼éŒ¯èª¤</p>';
      return;
    }

    if (data.models.length === 0) {
      modelsContainer.innerHTML = '<p style="text-align:center; color: gray;">ğŸš« ç›®å‰å°šç„¡å¯ç”¨çš„æ¨¡å‹</p>';
      return;
    }

    // å„²å­˜è‡³ mockModels
    mockModels.length = 0;
    mockModels.push(...data.models);

    // æ¸²æŸ“æ¨¡å‹æ¸…å–®
    data.models.forEach(model => {
      const checkboxItem = document.createElement('div');
      checkboxItem.className = 'checkbox-item';
      checkboxItem.style.display = 'flex';
      checkboxItem.style.alignItems = 'flex-start';
      checkboxItem.style.marginBottom = '12px';

      checkboxItem.innerHTML = `
        <input type="checkbox" id="model_${model.model_id}" name="model_id" value="${model.model_id}" style="margin-top: 6px; margin-right: 10px;">
        <div class="checkbox-content">
          <h4 style="margin: 0;">${model.model_name}ï¼ˆv${model.model_version}ï¼‰</h4>
          <p style="margin: 4px 0 0;">äº‹ä»¶é¡å‹ï¼š${model.event_type || 'ç„¡'}</p>
        </div>
      `;

      modelsContainer.appendChild(checkboxItem);
    });
  })
  .catch(err => {
    console.error("âŒ ç„¡æ³•è¼‰å…¥æ¨¡å‹è³‡æ–™ï¼š", err);
    alert("âŒ ç„¡æ³•è¼‰å…¥æ¨¡å‹è³‡æ–™ï¼š" + err.message);
    modelsContainer.innerHTML = '<p style="color: red;">âŒ è¼‰å…¥å¤±æ•—</p>';
  });
}





/*******************************è¯çµ¡äººè³‡è¨Š************************************/
async function loadContacts() {
    const token = localStorage.getItem("jwt");
    const contactsContainer = document.getElementById('contactsContainer');

    contactsContainer.innerHTML = '<p style="color: gray;">ğŸ”„ è¼‰å…¥è¯çµ¡äººä¸­...</p>';

    if (!token) {
        alert("âš ï¸ æ‰¾ä¸åˆ°ç™»å…¥æ†‘è­‰ï¼Œè«‹é‡æ–°ç™»å…¥");
        contactsContainer.innerHTML = '<p style="color: red;">âŒ ç„¡æ³•è¼‰å…¥ï¼šæœªç™»å…¥</p>';
        return;
    }

    fetch(`${API_BASE}/contact`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ token })
    })
    .then(res => {
        if (res.status === 200) {
            return res.json();
        } else {
            return res.json().then(err => {
                throw new Error(err.error || `ä¼ºæœå™¨éŒ¯èª¤ (${res.status})`);
            });
        }
    })
    .then(data => {
        contactsContainer.innerHTML = ''; // æ¸…ç©ºæç¤º

        if (!Array.isArray(data.contacts)) {
            contactsContainer.innerHTML = '<p style="color: red;">âš ï¸ è¯çµ¡äººè³‡æ–™æ ¼å¼éŒ¯èª¤</p>';
            return;
        }

        if (data.contacts.length === 0) {
            contactsContainer.innerHTML = '<p style="text-align:center; color: gray;">ğŸš« å°šç„¡è¯çµ¡äºº</p>';
            return;
        }

        // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
        mockContacts.length = 0;
        mockContacts.push(...data.contacts);

        // æ¸²æŸ“ checkbox é¸é …
        data.contacts.forEach(contact => {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';
            checkboxItem.style.display = 'flex';
            checkboxItem.style.alignItems = 'flex-start';
            checkboxItem.style.marginBottom = '12px';

            checkboxItem.innerHTML = `
                <input type="checkbox" id="contact_${contact.contact_id}" name="contact_id" value="${contact.contact_id}" style="margin-top: 6px; margin-right: 10px;">
                <div class="checkbox-content">
                    <h4 style="margin: 0;">${contact.contact_name}</h4>
                    <p style="margin: 4px 0 0;">ID: ${contact.contact_id}</p>
                </div>
            `;
            contactsContainer.appendChild(checkboxItem);
        });
    })
    .catch(err => {
        console.error("âŒ ç„¡æ³•è¼‰å…¥è¯çµ¡äººè³‡æ–™ï¼š", err);
        alert("âŒ ç„¡æ³•è¼‰å…¥è¯çµ¡äººè³‡æ–™ï¼š" + err.message);
        contactsContainer.innerHTML = '<p style="color: red;">âŒ è¼‰å…¥å¤±æ•—</p>';
    });
}







/*********************************æäº¤è¡¨å–®å‰ é è¦½é é¢*************************************/
function updatePreview() {
    const formData = new FormData(document.getElementById('multiStepForm'));
    const previewSection = document.getElementById('previewSection');

    // å°ˆæ¡ˆåç¨±
    const projectName = formData.get('')?.trim() || 'æœªè¨­å®š';

    // æ”å½±æ©Ÿ
    const selectedCamera = mockCameras.find(c => c.camera_id == formData.get('camera_id'));
    const cameraName = selectedCamera ? `${selectedCamera.camera_name} (${selectedCamera.ip_address})` : 'æœªé¸æ“‡';

    // è£ç½®ID
    const deviceID = formData.get('device_id')?.trim() || 'æœªè¨­å®š';

    // AI æ¨¡å‹
    const selectedModels = Array.from(document.querySelectorAll('input[name="model_id"]:checked'))
        .map(el => {
            const id = parseInt(el.value);
            const model = mockModels.find(m => m.model_id === id);
            return model ? `${model.model_name}ï¼ˆv${model.model_version}ï¼‰` : null;
        })
        .filter(Boolean);

    // è¯çµ¡äºº
    const selectedContacts = Array.from(document.querySelectorAll('input[name="contact_id"]:checked'))
        .map(el => {
            const id = parseInt(el.value);
            const contact = mockContacts.find(c => c.contact_id === id);
            return contact ? `${contact.contact_name} (ID: ${contact.contact_id})` : null;
        })
        .filter(Boolean);

    // é‹ä½œæ™‚é–“
    const startTime = formData.get('daily_start_time') || 'æœªè¨­å®š';
    const endTime = formData.get('daily_end_time') || 'æœªè¨­å®š';

    // çµ„åˆ HTML
    previewSection.innerHTML = `
        <h3 style="margin-top: 0; color: #6a4c93;">ğŸ“‹ å°ˆæ¡ˆè³‡è¨Šé è¦½</h3>

        <div class="preview-item">
            <span class="preview-label">å°ˆæ¡ˆåç¨±:</span>
            <span class="preview-value">${projectName}</span>
        </div>

        <div class="preview-item">
            <span class="preview-label">æ”å½±æ©Ÿ:</span>
            <span class="preview-value">${cameraName}</span>
        </div>

		<div class="preview-item">
            <span class="preview-label">è£ç½® ID:</span>
            <span class="preview-value">${deviceID}</span>
        </div>

        <div class="preview-item">
            <span class="preview-label">AI æ¨¡å‹:</span>
            <span class="preview-value">${selectedModels.length ? selectedModels.join(', ') : 'æœªé¸æ“‡'}</span>
        </div>

        <div class="preview-item">
            <span class="preview-label">é€šçŸ¥è¯çµ¡äºº:</span>
            <span class="preview-value">${selectedContacts.length ? selectedContacts.join(', ') : 'æœªé¸æ“‡'}</span>
        </div>

        <div class="preview-item">
            <span class="preview-label">æ¯æ—¥é‹ä½œæ™‚é–“:</span>
            <span class="preview-value">${startTime} - ${endTime}</span>
        </div>
    `;
}





/*********************************æäº¤è¡¨å–®*******************************/
document.getElementById('multiStepForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!validateCurrentStep()) return;

    const formData = new FormData(this);
    const project_name = formData.get('project_name')?.trim();
    const camera_id = parseInt(formData.get('camera_id'));
	const device_id = formData.get('device_id')?.trim();
    const contact_id = Array.from(document.querySelectorAll('input[name="contact_id"]:checked')).map(el => parseInt(el.value));
    const model_id = Array.from(document.querySelectorAll('input[name="model_id"]:checked')).map(el => parseInt(el.value));
    const daily_start_time = formData.get('daily_start_time');
    const daily_end_time = formData.get('daily_end_time');
    const token = localStorage.getItem("jwt") || "";

    const payload = {
        token,
        project_name,
        camera_id,
		device_id,
        start_time: {
            start: daily_start_time,
            end: daily_end_time
        },
        contact_id,
        model_id,
        event_id: [],
        status: "1"
    };

    const submitButton = document.querySelector('.submit-button');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.textContent = 'ğŸ”„ å»ºç«‹ä¸­...';
    //playRocketExplosion();

	fetch(`${API_BASE}/project/create`, {
		method: "POST",
		headers: {
			"Content-Type": "application/json"
		},
		body: JSON.stringify(payload)
	})
	.then(res => {
		if (res.status === 200) {
			//return res.json(); // å¯é¸ï¼Œçœ‹ä½ æ˜¯å¦æƒ³è™•ç†æˆåŠŸå›å‚³å…§å®¹
			//document.getElementById("successMessage").style.display = "block";
			setTimeout(() => {
			window.location.href = 'main.html';
		}, 5000);
		} else {
			return res.json().then(err => {
				throw new Error(err.error || `å»ºç«‹å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰`);
			});
		}
	})
	/*
	.then(data => {
		document.getElementById("successMessage").style.display = "block";
		setTimeout(() => {
			window.location.href = 'main.html';
		}, 5000);
	})
	*/
	.catch(err => {
		alert("âŒ å»ºç«‹å¤±æ•—ï¼š" + err.message);
		submitButton.disabled = false;
		submitButton.textContent = originalText;
	});
});

// åˆå§‹åŒ–
window.onload = async function() {
    // è¨­å®šé è¨­é–‹å§‹èˆ‡çµæŸæ™‚é–“
    const startInput = document.querySelector('input[name="daily_start_time"]');
    const endInput = document.querySelector('input[name="daily_end_time"]');



    // è¼‰å…¥å„é …è³‡æ–™
    await loadCameras();
    await loadModels();
    await loadContacts();

    if (startInput && endInput) {
        startInput.value = '08:00';
        endInput.value = '18:00';
    }

    // é¡¯ç¤ºåˆå§‹æ­¥é©Ÿ
    showStep(currentStep);
};


</script>

</body>
</html>
