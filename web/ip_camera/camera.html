<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>IP CAMERA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="/static/js/header.js"></script>
    <link rel="stylesheet" href="static/css/header.css">
	<link rel="stylesheet" href="static/css/camera.css">
</head>
<body>

    <div id="header-container"></div>

    <!-- é é¦–é•·æ¢ -->
    <header class="header-bar">
        <!-- æ¼¢å ¡é¸å–®æŒ‰éˆ• -->
        <button class="hamburger-menu" onclick="toggleSidebar()">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </button>

        <!-- === æ­£ä¸­å¤®åœ–ç‰‡å€å¡Š === -->
        <div class="header-center-logo">
            <img src="static/images/AI Monitor white.png" alt="ä¸­å¤®Logo">
        </div>
    </header>

    <!-- å´é‚Šé¸å–®é®ç½© -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- å´é‚Šé¸å–® -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <a href="main.html" class="sidebar-item" onclick="navigateWithAnimation(event, this, 'main.html')">
                <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                </svg>
                <span class="sidebar-text">å°ˆæ¡ˆ</span>
            </a>

            <a href="camera.html" class="sidebar-item active" onclick="navigateWithAnimation(event, this, 'camera.html')">
                <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                <span class="sidebar-text">æ”å½±æ©Ÿ</span>
            </a>

            <a href="contact.html" class="sidebar-item" onclick="navigateWithAnimation(event, this, 'contact.html')">
                <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-2.41 3.19c-.32.42-.26 1.02.14 1.37l2.28 2v4.44h2zm-7.5-10.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z"/>
                </svg>
                <span class="sidebar-text">è¯çµ¡äºº</span>
            </a>

            <a href="set.html" class="sidebar-item" onclick="navigateWithAnimation(event, this, 'set.html')">
                <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span class="sidebar-text">ç•°å¸¸é€šçŸ¥æŸ¥è©¢</span>
            </a>
        </div>
    </div>

    <div class="content" id="content">
        <div class="page-header">
            <div><strong>IP CAMERA</strong></div>
            <div class="tabs">
                <!-- <button class="tab active" onclick="showTab('streaming')">å³æ™‚ä¸²æµ</button> -->
                <button class="tab" onclick="showTab('manage')">ç®¡ç†æ”å½±æ©Ÿ</button>
                <button class="tab" onclick="showTab('add')">æ–°å¢æ”å½±æ©Ÿ</button>
            </div>
        </div>

        <!-- <section id="streaming"> -->
            <!-- <div id="streamingLoading" class="loading">è®€å–ä¸­...</div> -->
            <!-- <div id="cameraGrid" class="camera-grid hidden"></div> -->
        <!-- </section> -->

        <section id="manage" class="hidden">
            <div id="manageLoading" class="loading">è®€å–ä¸­...</div>
            <div id="cameraList" class="camera-list hidden"></div>
        </section>

        <!-- æ–°å¢æ”å½±æ©Ÿ -->
        <section id="add" class="hidden">
            <form id="cameraForm">
                <h2>æ–°å¢æ”å½±æ©Ÿ</h2>
                <input type="text" id="cameraName" placeholder="æ”å½±æ©Ÿåç¨±" required>
                <input type="text" id="deviceBrand" placeholder="å“ç‰Œ" required>
                <input type="text" id="deviceModel" placeholder="å‹è™Ÿ" required>
                <input type="text" id="ipAddress" placeholder="IP ä½å€" required>
                <input type="text" id="cameraUsername" placeholder="å¸³è™Ÿ" required>
                <input type="password" id="cameraPassword" placeholder="å¯†ç¢¼" required>
                <input type="text" id="rtspUrl" placeholder="RTSP ä¸²æµç¶²å€" required>
                <button type="submit">å„²å­˜</button>
            </form>
        </section>

        <!-- æ”å½±æ©Ÿè©³æƒ…ï¼ˆå¯ä¿®æ”¹èˆ‡åˆªé™¤ï¼‰ -->
        <section id="detail" class="hidden">
            <div class="camera-item">
                <h2>æ”å½±æ©Ÿè©³æƒ…</h2>
                <input class="edit-input" id="editCameraName" placeholder="åç¨±">
                <input class="edit-input" id="editDeviceBrand" placeholder="å“ç‰Œ">
                <input class="edit-input" id="editDeviceModel" placeholder="å‹è™Ÿ">
                <input class="edit-input" id="editIpAddress" placeholder="IP ä½å€">
                <input class="edit-input" id="editCameraUsername" placeholder="å¸³è™Ÿ">
                <input class="edit-input" id="editCameraPassword" placeholder="å¯†ç¢¼">
                <input class="edit-input" id="editRtspUrl" placeholder="RTSP ä¸²æµç¶²å€">
                <div style="margin-top: 15px;">
                    <button onclick="saveCameraEdit()">ğŸ’¾ å„²å­˜</button>
                    <button class="btn-delete" onclick="deleteCamera()">ğŸ—‘ åˆªé™¤</button>
                    <button onclick="showTab('manage')">â¬… è¿”å›</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        const API_BASE = 'http://210.240.202.108:5000';
        //const API_BASE = 'http://aimonitor.dpdns.org';
        let currentCameraId = null;  // æš«å­˜ç•¶å‰æ”å½±æ©Ÿ ID

        // å´é‚Šé¸å–®æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const hamburger = document.querySelector('.hamburger-menu');
            const content = document.getElementById('content');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
            
            if (window.innerWidth > 768) {
                content.classList.toggle('sidebar-open');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const hamburger = document.querySelector('.hamburger-menu');
            const content = document.getElementById('content');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            hamburger.classList.remove('active');
            content.classList.remove('sidebar-open');
        }

        // å°èˆªå‹•ç•«
        function navigateWithAnimation(event, element, url) {
            event.preventDefault();
            
            // ç§»é™¤å…¶ä»–é …ç›®çš„ active ç‹€æ…‹
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ·»åŠ ç•¶å‰é …ç›®çš„ active ç‹€æ…‹
            element.classList.add('active');
            
            // å»¶é²è·³è½‰
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }

        function loadHeader() {
            console.log('Header loaded');
        }

        /*=========================== æ–°å¢æ”å½±æ©Ÿ =============================*/
        const cameraForm = document.getElementById('cameraForm');

        const cameraError = document.createElement('div');
        cameraError.style.color = 'red';
        cameraError.style.marginTop = '10px';
        cameraForm.insertBefore(cameraError, cameraForm.firstChild);

        const successMessage = document.createElement('div');
        successMessage.style.color = 'green';
        successMessage.style.marginTop = '10px';
        successMessage.style.display = 'none';
        successMessage.textContent = 'âœ… æ”å½±æ©Ÿæ–°å¢æˆåŠŸï¼';
        cameraForm.insertBefore(successMessage, cameraForm.firstChild);

function showTab(tabId) {
    if (tabId === 'detail') {
        document.querySelectorAll('.content section').forEach(section => section.classList.add('hidden'));
        document.getElementById('detail').classList.remove('hidden');
        return;
    }

    const tabButtons = { 'streaming': 0, 'manage': 1, 'add': 2 };
    const index = tabButtons[tabId];
    if (index === undefined) {
        console.error(`âŒ ç„¡æ•ˆçš„ tabId: ${tabId}`);
        return;
    }

    document.querySelectorAll('.content section').forEach(section => section.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabId).classList.remove('hidden');
    document.querySelectorAll('.tab')[index].classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });

    if (tabId === 'add') {
        cameraError.textContent = '';
        successMessage.style.display = 'none';
        cameraForm.reset();
    }
}


        cameraForm.addEventListener('submit', function (e) {
            e.preventDefault();
            cameraError.textContent = '';
            successMessage.style.display = 'none';

            const token = localStorage.getItem('jwt');
            if (!token) {
                cameraError.textContent = 'âŒ æœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥å¾Œå†æ“ä½œ';
                return;
            }

            const data = {
                token,
                camera_name: cameraForm.cameraName.value.trim(),
                brand: cameraForm.deviceBrand.value.trim(),
                model: cameraForm.deviceModel.value.trim(),
                ip_address: cameraForm.ipAddress.value.trim(),
                camera_username: cameraForm.cameraUsername.value.trim(),
                camera_password: cameraForm.cameraPassword.value.trim(),
                rtsp_url: cameraForm.rtspUrl.value.trim()
            };

            if (Object.values(data).some(v => !v)) {
                cameraError.textContent = 'âš ï¸ è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½';
                return;
            }

            /*=========================== fetch /camera/create api =============================*/
            fetch(`${API_BASE}/camera/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.status === 200) {
                        successMessage.style.display = 'block';
                        setTimeout(() => {
                            cameraForm.reset();
                            successMessage.style.display = 'none';
                        }, 1500);
                    } else {
                        cameraError.textContent = response.status === 401 ? 'âŒ æœªæˆæ¬Š' :
                            response.status === 400 ? 'âš ï¸ è³‡æ–™ä¸å®Œæ•´' :
                                'âš ï¸ æ–°å¢å¤±æ•—';
                    }
                })
                .catch(() => cameraError.textContent = 'âš ï¸ ç„¡æ³•é€£ç·šä¼ºæœå™¨');
        });

        /*=========================== é¡¯ç¤ºç®¡ç†åˆ—è¡¨ =============================*/
        document.querySelector('.tab:nth-child(2)').addEventListener('click', () => {
            const token = localStorage.getItem('jwt');
            if (!token) {
                document.getElementById('manageLoading').textContent = 'âŒ æœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥';
                return;
            }

            document.getElementById('manageLoading').classList.remove('hidden');
            document.getElementById('cameraList').classList.add('hidden');
            document.getElementById('cameraList').innerHTML = '';

            /*=========================== fetch /camera api =============================*/
            fetch(`${API_BASE}/camera`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            })
                .then(res => res.json())
                .then(data => {
                    console.log('camera list data:', data);

                    document.getElementById('manageLoading').classList.add('hidden');
                    const list = document.getElementById('cameraList');
                    if (data.cameras) {
                        list.classList.remove('hidden');
                        data.cameras.forEach(cam => {
                            const item = document.createElement('div');
                            item.className = 'camera-manage-item';
                            item.innerHTML = `
                <div><strong>${cam.camera_name}</strong> (${cam.brand} ${cam.model})</div>
                <div><button class="btn-show" onclick='showCameraDetail(${JSON.stringify(cam)})'>æŸ¥çœ‹</button></div>
              `;
                            list.appendChild(item);
                        });
                    } else {
                        list.textContent = 'âš ï¸ ç„¡æ”å½±æ©Ÿè³‡æ–™';
                    }
                })
                .catch(() => document.getElementById('manageLoading').textContent = 'âš ï¸ è¼‰å…¥å¤±æ•—');
        });

        function showCameraDetail(cam) {
            currentCameraId = cam.camera_id;
            document.getElementById('editCameraName').value = cam.camera_name;
            document.getElementById('editDeviceBrand').value = cam.brand;
            document.getElementById('editDeviceModel').value = cam.model;
            document.getElementById('editIpAddress').value = cam.ip_address;
            document.getElementById('editCameraUsername').value = cam.camera_username;
            document.getElementById('editCameraPassword').value = cam.camera_password;
            document.getElementById('editRtspUrl').value = cam.rtsp_url;
            showTab('detail');
        }

        function saveCameraEdit() {
            const token = localStorage.getItem('jwt');
            if (!token || !currentCameraId) return alert('âŒ æœªç™»å…¥æˆ–è³‡æ–™éŒ¯èª¤');

            const payload = {
                token,
                camera_id: currentCameraId,
                camera_name: document.getElementById('editCameraName').value,
                brand: document.getElementById('editDeviceBrand').value,
                model: document.getElementById('editDeviceModel').value,
                ip_address: document.getElementById('editIpAddress').value,
                camera_username: document.getElementById('editCameraUsername').value,
                camera_password: document.getElementById('editCameraPassword').value,
                rtsp_url: document.getElementById('editRtspUrl').value
            };

            /*=========================== fetch /camera/update api =============================*/
            fetch(`${API_BASE}/camera/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (res.status === 200) {
                        alert('âœ… ä¿®æ”¹æˆåŠŸ');
                        showTab('manage');
                    } else {
                        alert('âš ï¸ ä¿®æ”¹å¤±æ•—');
                    }
                })
                .catch(() => alert('âš ï¸ ç„¡æ³•é€£ç·šä¼ºæœå™¨'));
        }

        function deleteCamera() {
            const token = localStorage.getItem('jwt');
            if (!token || !currentCameraId) return alert('âŒ æœªç™»å…¥æˆ–è³‡æ–™éŒ¯èª¤');
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™æ”¯æ”å½±æ©Ÿå—ï¼Ÿ')) return;

            /*=========================== fetch /camera/delete api =============================*/
            fetch(`${API_BASE}/camera/delete`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, camera_id: currentCameraId })
            })
                .then(res => {
                    if (res.status === 200) {
                        alert('ğŸ—‘ å·²åˆªé™¤');
                        location.reload();
                    } else {
                        alert('âš ï¸ åˆªé™¤å¤±æ•—');
                    }
                })
                .catch(() => alert('âš ï¸ ç„¡æ³•é€£ç·šä¼ºæœå™¨'));
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰å´é‚Šé¸å–®
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.querySelector('.hamburger-menu');
            
            if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
                if (sidebar.classList.contains('active')) {
                    closeSidebar();
                }
            }
        });

        window.onload = function() {
            loadHeader();
        };
    </script>
</body>
</html>