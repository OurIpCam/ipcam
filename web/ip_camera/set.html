<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>異常通知查詢</title>
  
  <script src="/static/js/header.js"></script>
  <link rel="stylesheet" href="/static/css/header.css">
</head>
<body>
  <style>
      body {
          margin: 0;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
          background: #ffffff;
          color: #191919;
          line-height: 1.6;
          padding-top: 70px;
      }

      /* === 頁首固定長條 === */
      .header-bar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          height: 70px;
          background-color: #000;
          color: white;
          padding: 0 30px;
          z-index: 100;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
      }

      /* === 漢堡選單按鈕 === */
      .hamburger-menu {
          position: fixed;
          top: 15px;
          left: 15px;
          width: 40px;
          height: 40px;
          background: rgba(255, 255, 255, 0.1);
          border: none;
          border-radius: 8px;
          cursor: pointer;
          z-index: 101;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 4px;
          transition: all 0.3s ease;
      }

      .hamburger-menu:hover {
          background: rgba(255, 255, 255, 0.2);
      }

      .hamburger-line {
          width: 20px;
          height: 2px;
          background: white;
          transition: all 0.3s ease;
      }

      .hamburger-menu.active .hamburger-line:nth-child(1) {
          transform: rotate(45deg) translate(5px, 5px);
      }

      .hamburger-menu.active .hamburger-line:nth-child(2) {
          opacity: 0;
      }

      .hamburger-menu.active .hamburger-line:nth-child(3) {
          transform: rotate(-45deg) translate(7px, -6px);
      }

      /* === 側邊選單 === */
      .sidebar {
          position: fixed;
          top: 70px;
          left: -280px;
          width: 280px;
          height: calc(100vh - 70px);
          background-color: #ffffff;
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
          z-index: 50;
          transition: left 0.3s ease;
          border-right: 1px solid #f0f0f0;
      }

      .sidebar.active {
          left: 0;
      }

      .sidebar-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 40;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
      }

      .sidebar-overlay.active {
          opacity: 1;
          visibility: visible;
      }

      .sidebar-content {
          padding: 30px 0;
      }

      .sidebar-item {
          display: flex;
          align-items: center;
          padding: 15px 30px;
          text-decoration: none;
          color: #333;
          transition: all 0.3s ease;
          border-left: 4px solid transparent;
      }

      .sidebar-item:hover {
          background-color: #f8f9fa;
          border-left-color: #000;
          color: #000;
      }

      .sidebar-item.active {
          background-color: #f0f0f0;
          border-left-color: #000;
          color: #000;
      }

      .sidebar-icon {
          width: 24px;
          height: 24px;
          margin-right: 15px;
          flex-shrink: 0;
      }

      .sidebar-text {
          font-size: 16px;
          font-weight: 500;
      }

      /* === 新增：置中圖片樣式 === */
      .header-center-logo {
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          pointer-events: none;
      }

      .header-center-logo img {
          height: 25px;
          object-fit: contain;
          transition: filter 0.3s ease;
      }

      /* === 頁首：當滑鼠懸停時，變更頁首背景色和 logo 顏色 === */
      .header-bar:hover {
          background-color: white;
          color: black;
      }

      .header-bar:hover .header-title {
          color: black;
      }

      .header-bar:hover .hamburger-line {
          background: black;
      }

      .header-bar:hover .header-center-logo img {
          filter: brightness(0);
      }

      .content {
          margin-left: 0;
          padding: 40px;
          max-width: 1200px;
          transition: margin-left 0.3s ease;
      }

      .content.sidebar-open {
          margin-left: 280px;
      }

      .container {
          position: relative;
          width: 100%;
          max-width: 700px;
          margin: 0 auto;
          text-align: center;
      }

      .step-header {
          background: white;
          color: black;
          padding: 20px;
          border-radius: 16px 16px 0 0;
          margin-bottom: 0;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
          border: 2px solid #f0f0f0;
      }

      .step-header h1 {
          margin: 0;
          font-size: 28px;
          font-weight: 700;
          color: black;
      }

      .step-header p {
          margin: 8px 0 0 0;
          opacity: 0.7;
          font-size: 16px;
          color: #666;
      }

      .content-section {
          text-align: left;
          background: white;
          padding: 32px;
          border-radius: 0 0 12px 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          border: 2px solid #f0f0f0;
          border-top: none;
          min-height: 400px;
          position: relative;
      }

      .content-section h2 {
          font-size: 24px;
          margin-bottom: 24px;
          color: black;
          font-weight: 600;
      }

      .form-group {
          margin-bottom: 24px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: black;
          font-size: 16px;
      }

      .form-group input[type="text"],
      .form-group input[type="email"],
      .form-group input[type="password"],
      .form-group input[type="date"],
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s ease;
          background-color: #f8f9fa;
          box-sizing: border-box;
          color: #666;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          border-color: #666;
          box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
          outline: none;
          background-color: white;
      }

      .submit-button {
          background: black;
          color: white;
          border: none;
          padding: 16px 32px;
          border-radius: 8px;
          font-size: 18px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      .submit-button:hover {
          background: #333;
          transform: translateY(-2px);
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      /* 異常通知列表樣式 */
      .notification-list {
          margin-top: 30px;
          border-top: 1px solid #e0e0e0;
          padding-top: 20px;
      }

      .notification-item {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 16px;
          margin-bottom: 12px;
          border-left: 4px solid #dc3545;
          transition: all 0.3s ease;
      }

      .notification-item:hover {
          background: #f0f0f0;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .notification-header {
          display: flex;
          justify-content: space-between;
          margin-bottom: 8px;
      }

      .notification-title {
          font-weight: 600;
          font-size: 16px;
          color: #333;
          margin: 0;
      }

      .notification-time {
          font-size: 14px;
          color: #666;
      }

      .notification-model {
          font-size: 14px;
          color: #666;
          margin-bottom: 8px;
      }

      .notification-content {
          font-size: 14px;
          color: #333;
      }

      .notification-severity-high {
          border-left-color: #dc3545;
      }

      .notification-severity-medium {
          border-left-color: #ffc107;
      }

      .notification-severity-low {
          border-left-color: #17a2b8;
      }

      /* 分頁控制樣式 */
      .pagination {
          display: flex;
          justify-content: center;
          margin-top: 30px;
          gap: 8px;
      }

      .pagination-button {
          background: white;
          border: 1px solid #e0e0e0;
          color: #333;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .pagination-button:hover {
          background: #f0f0f0;
      }

      .pagination-button.active {
          background: black;
          color: white;
          border-color: black;
      }

      .pagination-button.disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      /* 查詢表單樣式 */
      .search-form {
          display: grid;
          grid-template-columns: 1fr;
          gap: 16px;
      }

      .search-actions {
          display: flex;
          justify-content: space-between;
          margin-top: 24px;
      }

      .reset-button {
          background: #6c757d;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .reset-button:hover {
          background: #5a6268;
      }

      .no-results {
          text-align: center;
          padding: 40px 0;
          color: #666;
      }

      .no-results h3 {
          font-size: 20px;
          margin-bottom: 8px;
      }

      .no-results p {
          font-size: 16px;
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
          .content.sidebar-open {
              margin-left: 0;
          }

          .sidebar {
              width: 100%;
              left: -100%;
          }

          .sidebar.active {
              left: 0;
          }

          .content {
              padding: 20px;
          }

          .container {
              width: 100%;
          }

          .step-header h1 {
              font-size: 24px;
          }

          .step-header p {
              font-size: 14px;
          }

          .content-section {
              padding: 24px;
          }

          /* 修改header-bar在手機畫面的樣式 */
          .header-bar {
              padding: 0 15px;
          }
      
          .hamburger-menu {
              top: 15px;
              left: 15px;
          }
      
          .header-center-logo img {
              height: 25px;
          }
      }

      /* 修改手機尺寸下的header-bar樣式，與index.html保持一致 */
      @media (max-width: 480px) {
          .content {
              padding: 15px;
          }

          .step-header {
              padding: 15px;
          }

          .content-section {
              padding: 20px;
          }

          .step-header h1 {
              font-size: 22px;
          }

          .form-group input,
          .form-group select,
          .form-group textarea {
              font-size: 16px;
              padding: 12px;
          }

          /* 與index.html保持一致的header樣式 */
          .header-bar {
              height: 70px;
          }

          .header-center-logo {
              position: absolute;
              left: 50%;
              transform: translateX(-50%);
              height: auto;
              top: 30px;
          }

          .header-center-logo img {
              height: 15px;
          }

          .hamburger-menu {
              width: 40px;
              height: 40px;
              top: 15px;
              left: 15px;
          }

          body {
              padding-top: 70px;
          }
      }
  </style>

  <div id="header-container"></div>

  <!-- 頁首長條 -->
  <header class="header-bar">
      <!-- 漢堡選單按鈕 -->
      <button class="hamburger-menu" onclick="toggleSidebar()">
          <div class="hamburger-line"></div>
          <div class="hamburger-line"></div>
          <div class="hamburger-line"></div>
      </button>

      <!-- === 正中央圖片區塊 === -->
      <div class="header-center-logo">
          <img src="static/images/AI Monitor white.png" alt="中央Logo">
      </div>
  </header>

  <!-- 側邊選單遮罩 -->
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- 側邊選單 -->
  <div class="sidebar" id="sidebar">
      <div class="sidebar-content">
          <a href="main.html" class="sidebar-item" onclick="navigateWithAnimation(event, this, 'main.html')">
              <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
              </svg>
              <span class="sidebar-text">專案</span>
          </a>

          <a href="camera.html" class="sidebar-item" onclick="navigateWithAnimation(event, this, 'camera.html')">
              <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
              </svg>
              <span class="sidebar-text">攝影機</span>
          </a>

          <a href="contact.html" class="sidebar-item" onclick="navigateWithAnimation(event, this, 'contact.html')">
              <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-2.41 3.19c-.32.42-.26 1.02.14 1.37l2.28 2v4.44h2zm-7.5-10.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z"/>
              </svg>
              <span class="sidebar-text">聯絡人</span>
          </a>

          <a href="set.html" class="sidebar-item active" onclick="navigateWithAnimation(event, this, 'set.html')">
              <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span class="sidebar-text">異常通知</span>
          </a>
      </div>
  </div>

  <div class="content" id="content">
      <div class="container">
          <div class="step-header">
              <h1>異常通知查詢</h1>
              <p>查詢並管理系統異常通知記錄</p>
          </div>

          <div class="content-section">
              <h2>查詢條件</h2>
              
              <form id="searchForm" class="search-form">
                  <div class="form-group">
                      <label for="startDate">開始日期</label>
                      <input type="date" id="startDate" name="startDate">
                  </div>

                  <div class="form-group">
                      <label for="endDate">結束日期</label>
                      <input type="date" id="endDate" name="endDate">
                  </div>

                  <div class="form-group">
                      <label for="modelType">事件名稱</label>
                      <select id="modelType" name="modelType">
                          <option value="">全部模型</option>
                          <option value="person_detection">人員進入</option>
                          <option value="vehicle_detection"></option>
                          <option value="face_recognition">人臉辨識</option>
                          <option value="object_detection">物件偵測</option>
                          <option value="behavior_analysis">行為分析</option>
                      </select>
                  </div>

                  <div class="search-actions">
                      <button type="button" class="reset-button" onclick="resetForm()">
                          重置
                      </button>
                      <button type="submit" class="submit-button">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                          </svg>
                          查詢
                      </button>
                  </div>
              </form>

              <div class="notification-list" id="notificationList">
                  <!-- 通知列表將由JavaScript動態生成 -->
                  <div class="loading" id="loadingIndicator">載入中...</div>
              </div>

              <div class="pagination" id="pagination">
                  <!-- 分頁控制將由JavaScript動態生成 -->
              </div>
          </div>
      </div>
  </div>

  <script>
  
 
      // 側邊選單控制
      function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.querySelector('.sidebar-overlay');
          const hamburger = document.querySelector('.hamburger-menu');
          const content = document.getElementById('content');
          
          sidebar.classList.toggle('active');
          overlay.classList.toggle('active');
          hamburger.classList.toggle('active');
          
          if (window.innerWidth > 768) {
              content.classList.toggle('sidebar-open');
          }
      }

      function closeSidebar() {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.querySelector('.sidebar-overlay');
          const hamburger = document.querySelector('.hamburger-menu');
          const content = document.getElementById('content');
          
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          hamburger.classList.remove('active');
          content.classList.remove('sidebar-open');
      }

      // 導航動畫
      function navigateWithAnimation(event, element, url) {
          event.preventDefault();
          
          // 移除其他項目的 active 狀態
          document.querySelectorAll('.sidebar-item').forEach(item => {
              item.classList.remove('active');
          });
          
          // 添加當前項目的 active 狀態 
          element.classList.add('active');
          
          // 延遲跳轉
          setTimeout(() => {
              window.location.href = url;
          }, 300);
      }



let allEvents = [];
let currentPage = 1;
const itemsPerPage = 50;

document.addEventListener('DOMContentLoaded', () => {
  console.log('localStorage jwt:', localStorage.getItem('jwt'));
  fetchAllEvents();
});

async function fetchAllEvents() {
  const loadingEl = document.getElementById('loadingIndicator');
  if (loadingEl) loadingEl.style.display = 'block';

  try {
    const token = localStorage.getItem('jwt') || '';
    if (!token) throw new Error('找不到登入 jwt，請先登入');

    const response = await fetch('http://210.240.202.108:5000/events/user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })  // 使用 jwt 傳送
    });

    if (!response.ok) {
      let errMsg = `HTTP ${response.status}`;
      try {
        const errJson = await response.json();
        if (errJson.error) errMsg = errJson.error;
      } catch {}
      throw new Error(errMsg);
    }

    const data = await response.json();
    allEvents = (data.abnormal_events || []).map(e => ({
      title: e.event_name,
      time: e.occurred_at,
      model: e.model_name
    }));

    renderList();

  } catch (err) {
    alert('資料載入失敗：' + err.message);
    console.error(err);
  } finally {
    if (loadingEl) loadingEl.style.display = 'none';
  }
}

function renderList() {
  const list = document.getElementById('notificationList');
  if (!list) return;

  list.innerHTML = ''; // 清空原本內容

  if (allEvents.length === 0) {
    list.innerHTML = `<div class="no-results"><h3>無異常通知</h3><p>目前沒有任何異常事件</p></div>`;
    return;
  }

  allEvents.forEach(event => {
    const item = document.createElement('div');
    item.className = 'notification-item notification-severity-high';
    item.innerHTML = `
      <div class="notification-header">
        <p class="notification-title">${event.title}</p>
        <p class="notification-time">${new Date(event.time).toLocaleString()}</p>
      </div>
      <p class="notification-model">模型名稱：${event.model}</p>
      <p class="notification-content">異常事件已記錄</p>
    `;
    list.appendChild(item);
  });
}

  </script>
</body>
</html>
